<div class="mgmt">
  
  @if (isLoading) {
    <div class="mgmt__loading">
      <div class="spinner"></div>
      <p>Cargando datos...</p>
    </div>
  } 
  
  @else if (!hasTeam) {
    <div class="mgmt__create-container">
      <div class="mgmt__welcome-card">
        <header class="mgmt__welcome-header">
          <h1>Bienvenido, Jefe de Equipo</h1>
          <p>Para comenzar, funda tu escudería en la FIA.</p>
        </header>

        <form [formGroup]="createTeamForm" (ngSubmit)="onSubmitCreate()" class="mgmt__form">
          <div class="mgmt__field">
            <label class="mgmt__label">Nombre de la Escudería</label>
            <input class="mgmt__input" type="text" formControlName="nombre" placeholder="Ej: McLaren Mastercard F1">
          </div>

          <div class="mgmt__field">
            <label class="mgmt__label">Twitter Oficial (sin @)</label>
            <div class="mgmt__input-group">
              <span class="prefix">@</span>
              <input class="mgmt__input" type="text" formControlName="twitter" placeholder="McLarenF1">
            </div>
          </div>

          <div class="mgmt__field">
            <label class="mgmt__label">Logo</label>
            <app-image-uploader formControlName="logo"></app-image-uploader>
          </div>

          <button type="submit" class="mgmt__btn-submit" [disabled]="isCreating || createTeamForm.invalid">
            {{ isCreating ? 'Procesando...' : 'FUNDAR EQUIPO' }}
          </button>
        </form>
      </div>
    </div>
  } 
  
  @else {
    <header class="mgmt__header">
      <div class="mgmt__header__brand">
        <img [src]="team.logo" alt="Logo">
        <div>
          <span class="subtitle">PANEL DE CONTROL</span>
          <h1>{{ team.nombre | uppercase }}</h1>
          @if(team.twitter) {
            <a [href]="'https://x.com/' + team.twitter" target="_blank" class="mgmt__twitter-link">
              <i class="bi bi-twitter-x"></i> @{{ team.twitter }}
            </a>
          }
        </div>
      </div>
    </header>

    <section class="mgmt__section">
      <div class="mgmt__section__head">
        <h2><i class="bi bi-person-lock"></i> Gestión de Accesos</h2>
        <button class="btn-add" (click)="openModal('USER')"><i class="bi bi-plus-lg"></i> Autorizar</button>
      </div>
      
      <div class="mgmt__grid">
        @for (user of team.usuarios; track user.usuario) {
          <div class="card-simple">
            <div class="card-simple__avatar user-icon">
               <i class="bi bi-shield-lock-fill"></i>
            </div>
            <div class="card-simple__info">
              <span class="rol">Miembros del equipo</span>
              <span class="name">{{ user.usuario }}</span>
            </div>
            <button class="btn-del" (click)="deleteItem('USER', user.usuario)"><i class="bi bi-trash"></i></button>
          </div>
        }
      </div>
    </section>

    <section class="mgmt__section">
      <div class="mgmt__section__head">
        <h2><i class="bi bi-speedometer2"></i> Pilotos</h2>
        <button class="btn-add" (click)="openModal('DRIVER')"><i class="bi bi-plus-lg"></i> Añadir</button>
      </div>
      <div class="mgmt__grid">
        @for (driver of team.pilotos; track driver.id) {
          <div class="card-driver">
            <div class="card-driver__top">
              <span class="number">{{ driver.dorsal }}</span>
              <img [src]="driver.foto || 'assets/default.png'" class="photo">
            </div>
            <div class="card-driver__info">
              <span class="code">{{ driver.siglas }}</span>
              <span class="name">{{ driver.nombre }} {{ driver.apellidos }}</span>
              <small class="pais">{{ driver.pais }}</small>
              <a [href]="'https://x.com/' + driver.twitter" target="_blank" class="twitter-link">
                <i class="bi bi-twitter-x"></i> @{{ driver.twitter }}
              </a>
            </div>
            
            <div class="card-actions">
              <button class="btn-icon edit" (click)="openModal('DRIVER', driver)" title="Editar">
                <i class="bi bi-pencil-fill"></i>
              </button>
              <button class="btn-icon del" (click)="deleteItem('DRIVER', driver.id)" title="Eliminar">
                <i class="bi bi-trash-fill"></i>
              </button>
            </div>
            
          </div>
        }
      </div>
    </section>

    <section class="mgmt__section">
      <div class="mgmt__section__head">
        <h2><i class="bi bi-car-front-fill"></i> Monoplazas</h2>
        <button class="btn-add" (click)="openModal('CAR')"><i class="bi bi-plus-lg"></i> Añadir</button>
      </div>
      <div class="mgmt__list">
        @for (car of team.coches; track car.id) {
          <div class="card-list-item">
            <div class="card-list-item__main">
              <span class="model">{{ car.nombre }}</span>
              <span class="code">{{ car.codigo }}</span>
            </div>
            <div class="card-list-item__stats">
              <div class="stat"><i class="bi bi-fuel-pump-fill"></i> {{ car.consumo }} L</div>
              <div class="stat ers-group">
                <i class="bi bi-lightning-charge-fill"></i>
                <span>L:{{ car.ers_curva_lenta }}</span>
                <span>M:{{ car.ers_curva_media }}</span>
                <span>R:{{ car.ers_curva_rapida }}</span>
              </div>
            </div>
            
            <div class="list-actions">
              <button class="btn-icon edit" (click)="openModal('CAR', car)" title="Editar">
                <i class="bi bi-pencil-fill"></i>
              </button>
              <button class="btn-icon del" (click)="deleteItem('CAR', car.id)" title="Eliminar">
                <i class="bi bi-trash-fill"></i>
              </button>
            </div>

          </div>
        }
      </div>
    </section>
  }

  @if (currentModal) {
    <div class="modal-backdrop" (click)="closeModal()">
      <div class="modal-window" (click)="$event.stopPropagation()">
        
        <div class="modal-window__header">
          <h3>
            @if(currentModal === 'USER') { Autorizar Nuevo Usuario }
            @if(currentModal === 'DRIVER') { Fichar Piloto }
            @if(currentModal === 'CAR') { Fabricar Coche }
          </h3>
          <button class="close" (click)="closeModal()">&times;</button>
        </div>

        <div class="modal-window__body">
          @if (currentModal === 'USER') {
            <form [formGroup]="userForm" (ngSubmit)="submitUser()">
              <div class="form-group">
                <label>Nombre de Usuario</label>
                <input type="text" formControlName="usuario" placeholder="Ej: LawrenceStroll">
              </div>
              <button type="submit" class="btn-submit" [disabled]="userForm.invalid">Dar Acceso</button>
            </form>
          }
          @if (currentModal === 'DRIVER') {
            <form [formGroup]="driverForm" (ngSubmit)="submitDriver()">
              <div class="row">
                <div class="form-group"><label>Nombre</label><input type="text" formControlName="nombre"></div>
                <div class="form-group"><label>Apellidos</label><input type="text" formControlName="apellidos"></div>
              </div>
              <div class="row">
                <div class="form-group"><label>Siglas (3 letras)</label><input type="text" formControlName="siglas"></div>
                <div class="form-group"><label>Número</label><input type="number" formControlName="dorsal"></div>
              </div>
              <div class="row">
                <div class="form-group"><label>País</label><input type="text" formControlName="pais"></div>
                
                <div class="form-group">
                  <label>Twitter (sin @)</label>
                  <input type="text" formControlName="twitter" placeholder="Ej: FernandoAlonso">
                </div>
              </div>
              
              <div class="form-group"><label>Foto</label><app-image-uploader formControlName="foto"></app-image-uploader></div>
              <button type="submit" class="btn-submit" [disabled]="driverForm.invalid">Guardar</button>
            </form>
          }

          @if (currentModal === 'CAR') {
            <form [formGroup]="carForm" (ngSubmit)="submitCar()">
              <div class="form-group"><label>Nombre</label><input type="text" formControlName="nombre"></div>
              <div class="form-group"><label>Código</label><input type="text" formControlName="codigo"></div>
              <div class="form-group"><label>Consumo</label><input type="number" formControlName="consumo"></div>
              <div class="row">
                <div class="form-group"><label>ERS Curva Lenta</label><input type="number" formControlName="ers_curva_lenta" step="0.001"></div>
                <div class="form-group"><label>ERS Curva Media</label><input type="number" formControlName="ers_curva_media" step="0.001"></div>
                <div class="form-group"><label>ERS Curva Rápida</label><input type="number" formControlName="ers_curva_rapida" step="0.001"></div>
              </div>
              <button type="submit" class="btn-submit" [disabled]="carForm.invalid">Guardar</button>
            </form>
          }
        </div>
      </div>
    </div>
  }
</div>